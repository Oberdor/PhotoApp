{
  "openapi": "3.0.0",
  "info": {
    "title": "PhotoApp Payment API",
    "version": "1.0.0"
  },
  "paths": {
    "/api/payments/{paymentId}": {
      "patch": {
        "summary": "Częściowa aktualizacja statusu płatności i ewentualne zamknięcie kontraktu",
        "operationId": "patchPayment",
        "parameters": [
          {
            "name": "paymentId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "description": "Identyfikator płatności"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PaymentPatchRequest"
              },
              "examples": {
                "setAllTrue": {
                  "summary": "Oznaczenie wszystkich części jako opłacone (zamyka kontrakt)",
                  "value": {
                    "isDepositPaid": true,
                    "isBasePaid": true,
                    "isAdditionalPaid": true
                  }
                },
                "partialUpdate": {
                  "summary": "Częściowa aktualizacja (bez zamykania kontraktu)",
                  "value": {
                    "isDepositPaid": true
                  }
                },
                "noChangeOnMissingFields": {
                  "summary": "Brak zmiany dla nieprzesłanych pól",
                  "value": {
                    "isBasePaid": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Płatność zaktualizowana poprawnie",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PaymentDto"
                },
                "examples": {
                  "contractClosed": {
                    "summary": "Wszystkie części opłacone, kontrakt zamknięty",
                    "value": {
                      "id": 123,
                      "deposit": 100.0,
                      "basePayment": 400.0,
                      "additionalPayment": 50.0,
                      "isDepositPaid": true,
                      "isBasePaid": true,
                      "isAdditionalPaid": true,
                      "photoSessionId": 987,
                      "isContractFinished": true
                    }
                  },
                  "contractOpen": {
                    "summary": "Płatność częściowo opłacona, kontrakt nadal otwarty",
                    "value": {
                      "id": 123,
                      "deposit": 100.0,
                      "basePayment": 400.0,
                      "additionalPayment": 50.0,
                      "isDepositPaid": true,
                      "isBasePaid": false,
                      "isAdditionalPaid": false,
                      "photoSessionId": 987,
                      "isContractFinished": false
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Niepoprawne dane wejściowe (np. pusty body)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Płatność o podanym identyfikatorze nie istnieje",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "409": {
            "description": "Konflikt stanu, np. próba zmiany płatności dla zakończonego kontraktu (jeśli wprowadzimy taką regułę)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "PaymentPatchRequest": {
        "type": "object",
        "description": "Częściowa aktualizacja flag płatności. Pola pominięte w body NIE są zmieniane.",
        "properties": {
          "isDepositPaid": {
            "type": ["boolean", "null"],
            "description": "Nowa wartość flagi opłacenia zaliczki. Jeżeli pole nie zostanie przesłane w body, dotychczasowa wartość pozostaje bez zmian. Jeżeli zostanie przesłane z wartością null, traktujemy to jak błąd walidacji (400)."
          },
          "isBasePaid": {
            "type": ["boolean", "null"],
            "description": "Nowa wartość flagi opłacenia części podstawowej. Semantyka jak dla isDepositPaid."
          },
          "isAdditionalPaid": {
            "type": ["boolean", "null"],
            "description": "Nowa wartość flagi opłacenia części dodatkowej. Semantyka jak dla isDepositPaid."
          }
        },
        "additionalProperties": false,
        "example": {
          "isDepositPaid": true,
          "isBasePaid": false
        }
      },
      "PaymentDto": {
        "type": "object",
        "description": "Reprezentacja płatności wraz z powiązanym stanem kontraktu.",
        "properties": {
          "id": {
            "type": "integer",
            "format": "int64"
          },
          "deposit": {
            "type": "number",
            "format": "float"
          },
          "basePayment": {
            "type": "number",
            "format": "float"
          },
          "additionalPayment": {
            "type": "number",
            "format": "float"
          },
          "isDepositPaid": {
            "type": "boolean"
          },
          "isBasePaid": {
            "type": "boolean"
          },
          "isAdditionalPaid": {
            "type": "boolean"
          },
          "photoSessionId": {
            "type": "integer",
            "format": "int64",
            "description": "Identyfikator powiązanej sesji zdjęciowej"
          },
          "isContractFinished": {
            "type": "boolean",
            "description": "Aktualny stan kontraktu dla sesji powiązanej z tą płatnością. Ustawiany automatycznie na true, gdy wszystkie trzy flagi płatności są true po wykonaniu PATCH."
          }
        },
        "required": [
          "id",
          "deposit",
          "basePayment",
          "additionalPayment",
          "isDepositPaid",
          "isBasePaid",
          "isAdditionalPaid",
          "photoSessionId",
          "isContractFinished"
        ]
      },
      "ErrorResponse": {
        "type": "object",
        "description": "Standardowa odpowiedź błędu API.",
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "status": {
            "type": "integer",
            "format": "int32"
          },
          "error": {
            "type": "string"
          },
          "message": {
            "type": "string"
          },
          "path": {
            "type": "string"
          }
        },
        "required": ["status", "error", "message"]
      }
    }
  }
}
